<!doctype html>
<html lang="en" ng-app>
<head>
    <title>Chat Example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootstrap-responsive.min.css">
    <style>
        body {
            padding-top: 60px;
        }
    </style>
    <script>
        function ChatController($scope) {
            var socket = io.connect();

            $scope.messages = [];
            $scope.roster = [];
            $scope.name = '';
            $scope.text = '';
            $scope.rangeValue = 50;

            $scope.machineCounters = [];


            socket.on('connect', function () {
                $scope.setName();
            });

            socket.on('counter', function (msg) {
                console.log('received counter message ------------');
                console.log(msg);


                var copiedMsg = angular.copy(msg);


                //$scope.machineCounters.push(copiedMsg);

                var index = getCounterIndex(msg);

                console.log('returned index ' + index);

                if (index === -1) {
                    $scope.machineCounters.push(copiedMsg);
                }
                else {
                    $scope.machineCounters[index] = copiedMsg;
                }

                $scope.$apply();

                //$scope.counters[msg.machine] = msg;

                //console.log($scope.counters);

            });

            function getCounterIndex(counter) {
                var index = -1;
                var arrayLength = $scope.machineCounters.length;
                for (var i = 0; i < arrayLength; i++) {
                    console.log($scope.machineCounters[i].machine);
                    if ($scope.machineCounters[i].machine === counter.machine) {
                        index = i;
                        break
                    }
                }
                return index;
            }


            socket.on('message', function (msg) {
                $scope.messages.push(msg);

                var num = parseFloat(msg.text);

                if (!isNaN(num)) {
                    $scope.rangeValue = num;
                }
                //if (msg.name === '/api/notify') {
                //      $scope.rangeValue = msg.text;
                // }
                $scope.$apply();
            });

            socket.on('roster', function (names) {
                $scope.roster = names;
                $scope.$apply();
            });

            $scope.send = function send() {
                console.log('Sending message:', $scope.text);
                socket.emit('message', $scope.text);
                $scope.text = '';
            };

            $scope.setName = function setName() {
                socket.emit('identify', $scope.name);
            };
        }
    </script>
</head>
<body>
<div class="container" ng-controller="ChatController">
    <div class="navbar navbar-fixed-top navbar-inverse">
        <div class="navbar-inner">
            <div class="pull-right">
                <a href="https://c9.io" class="brand">Pulse</a>
            </div>
        </div>
    </div>
    <div class="page-header">
        <h1>Performance Counters</h1>
    </div>
    <div class="row">
        <div class="span3">
            <ul class="nav nav-list well">
                <li class="nav-header">Local Users</li>
                <li ng-repeat="user in roster" ng-bind="user">
                </li>
            </ul>
        </div>
        <div class="span9">
            <table class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th class="span2">Name</th>
                    <th class="span7">Text</th>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="msg in messages">
                    <td class="span2" ng-bind="msg.name"></td>
                    <td class="span7" ng-bind="msg.text"></td>
                </tr>
                </tbody>
            </table>
            <div class="row controls">
                <form ng-submit="send()">
                    <div class="span2"><input type="text" class="input-block-level" ng-model="name"
                                              ng-change="setName()" placeholder="Your Name"></div>
                    <div class="input-append span7">
                        <input type="text" class="span6" ng-model="text" placeholder="Message">
                        <input type="submit" class="span1 btn btn-primary" value="Send" ng-disabled="!text">
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div>
        <input type="range" min="0" max="100" ng-model="rangeValue"/>
        {{rangeValue}} {{machineCounters.length}}
    </div>
    <div ng-repeat="mc in machineCounters">
        <div>
            {{mc.machine}} - {{mc.dateTime}}
            <ul ng-repeat="ctr in mc.counters">
                <li>{{ctr.counter}} {{ctr.value}}</li>
            </ul>

        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/angular.min.js"></script>
</body>
</html>
